<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            font-family: Monospace;
            background-color: #000;
            color: #fff;
            margin: 0px;
            overflow: hidden;
        }
    </style>
</head>

<body>

<script src="js/three.js/build/three.js"></script>
<script src="js/three.js/examples/js/loaders/OBJLoader.js"></script>

<script src="/socket.io/socket.io.js"></script>
<script src="js/three.js/examples/js/Stats.js"></script>

<script>
    var socket = io.connect('http://localhost:3001');

    var lastNavdata = null;
    socket.on('navdata', function (data) {
        lastNavdata = data.demo;
    });


    var container, stats;

    var camera, object, scene, renderer;

    init();
    animate();

    function init() {
        container = document.createElement('div');
        document.body.appendChild(container);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 8000);
        camera.position.z = 6000;
        camera.position.y = 1000;

        // scene
        scene = new THREE.Scene();

        var ambient = new THREE.AmbientLight(0x404030);
        scene.add(ambient);

        var directionalLight = new THREE.DirectionalLight(0xffeedd);
        directionalLight.position.set(0, 0, 1).normalize();
        scene.add(directionalLight);

        // model
        var loader = new THREE.OBJLoader();
        loader.addEventListener('load', function (event) {
            object = event.content;

            console.log(object);

            object.position.y = 0;
            object.scale.set(0.01,0.01,0.01);
            scene.add(object);
        });



        // GROUND

        var imageCanvas = document.createElement( "canvas" ),
            context = imageCanvas.getContext( "2d" );

        imageCanvas.width = imageCanvas.height = 128;

        context.fillStyle = "#aac";
        context.fillRect( 0, 0, 128, 128 );

        context.fillStyle = "#ccf";
        context.fillRect( 0, 0, 64, 64);
        context.fillRect( 64, 64, 64, 64 );

        var textureCanvas = new THREE.Texture( imageCanvas, THREE.UVMapping, THREE.RepeatWrapping, THREE.RepeatWrapping),
            materialCanvas = new THREE.MeshBasicMaterial( { map: textureCanvas } );

        textureCanvas.needsUpdate = true;
        textureCanvas.repeat.set( 1000, 1000 );

        var geometry = new THREE.PlaneGeometry( 100, 100 );

        var floor = new THREE.Mesh( geometry, materialCanvas );
        floor.rotation.x = - Math.PI / 2;
        floor.scale.set( 10000, 10000, 10000 );
        floor.position.y = -1000;

        scene.add(floor);





        // DRONE
        loader.load('ardrone2.obj');

        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        render();
    }


    var RAD_PER_DEG = Math.PI/180;
    function deg2Rad(deg) {
        return parseFloat(deg)*RAD_PER_DEG;
    }

    function render() {
        if(lastNavdata) {
            var x = lastNavdata.frontBackDegrees, y = lastNavdata.leftRightDegrees, z = lastNavdata.clockwiseDegrees,
                xr = deg2Rad(x), yr = deg2Rad(y), zr = deg2Rad(z);

            object.rotation.set( -xr, -zr, -yr);
        }

        camera.lookAt(scene.position);

        renderer.render(scene, camera);
    }








    var doc = document,
        $ = doc.getElementById.bind(doc),
        query = function (selector, scope) { return (scope || doc).querySelectorAll(); };

    var keymap = {
        87 : { ev: 'move', param: 'front' }, // 'W'
        83 : { ev: 'move', param: 'back' }, // 'S'
        65 : { ev: 'move', param: 'left' }, // 'A'
        68 : { ev: 'move', param: 'right' }, // 'D'
        38 : { ev: 'move', param: 'up' }, // up
        40 : { ev: 'move', param: 'down' }, // down
        37 : { ev: 'rotate', param: 'counterClockwise' }, // left
        39 : { ev: 'rotate', param: 'clockwise' }, // right
        32 : { ev: 'drone', param: 'takeoff' }, // space
        27 : { ev: 'drone', param: 'land' }  // esc
    };

    doc.addEventListener("keydown", function (ev) {
        if(keymap[ev.keycode]) {
            ev.preventDefault();

            var evData = keymap[ev.keycode];
            socket.emit(evData.ev, evData.param);
        }
    }, false);
</script>

</body>
</html>
