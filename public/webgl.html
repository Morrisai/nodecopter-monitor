<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        * { margin: 0; padding: 0; }
        body {
            font-family: Monospace;
            background-color: #000;
            color: #fff;
            margin: 0px;
            overflow: hidden;
        }

        #cam {
            position: absolute;
                top: 0; right: 0;
            width: 400px;
            height: auto;

            opacity: 0.9;
        }

        #battery {
            position: absolute;
                top: 0; left: 0;

            font-family: monospace;
            font-size: 26px;
        }

        #stateData {
            color: white;
            font-size: 10px;
            font-family: monospace;
            position: absolute;
                bottom: 0; right: 0;

            width: 300px; height: 200px;

            background: rgba(0,0,0,0.5);
        }
    </style>
</head>

<body>

<img id="cam" src="about:blank" />
<div id="battery">Battery: <span id="batteryMeter">100</span>%</div>
<pre id="stateData"></pre>
<script src="js/three.js/build/three.js"></script>
<script src="js/three.js/examples/js/loaders/OBJLoader.js"></script>

<script src="/socket.io/socket.io.js"></script>
<script src="js/three.js/examples/js/Stats.js"></script>

<script>
    var doc = document,
        $ = doc.getElementById.bind(doc),
        query = function (selector, scope) { return (scope || doc).querySelectorAll(); };

    var socket = io.connect('http://localhost:3001');

    var lastNavdata = null, lastBatteryPercentage = 100,
        batteryMeter = $('batteryMeter');

    var loggingPaused = false,
            stateData = $('stateData');

    socket.on('navdata', function (data) {
        lastNavdata = data.demo;

        if(!loggingPaused) {
            //console.log(data);
            stateData.innerHTML = JSON.stringify(data.demo, null, 2);
            loggingPaused = true;
            setTimeout(function() { loggingPaused=false; }, 100);
        }

        if(data.demo.batteryPercentage !== lastBatteryPercentage) {
            lastBatteryPercentage = data.demo.batteryPercentage;
            batteryMeter.innerHTML = lastBatteryPercentage;
        }
    });
/*
    var camImg = doc.getElementById('cam');
    socket.on('image', function(src) {
        console.log('received an imageâ€¦');
        cam.src=src;
    });
*/

    var container, stats;

    var camera, object, scene, renderer;

    init();
    animate();

    function init() {
        container = document.createElement('div');
        document.body.appendChild(container);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 8000);
        camera.position.z = 6000;
        camera.position.y = 1000;

        // scene
        scene = new THREE.Scene();

        var ambient = new THREE.AmbientLight(0x404030);
        scene.add(ambient);

        var directionalLight = new THREE.DirectionalLight(0xffeedd);
        directionalLight.position.set(0, 0, 1).normalize();
        scene.add(directionalLight);

        // model
        var loader = new THREE.OBJLoader();
        loader.addEventListener('load', function (event) {
            object = event.content;

            console.log(object);

            object.position.y = 0;
            object.scale.set(0.01,0.01,0.01);
            scene.add(object);
        });



        // GROUND
        var imageCanvas = document.createElement( "canvas" ),
            context = imageCanvas.getContext( "2d" );

        imageCanvas.width = imageCanvas.height = 512;
        context.fillStyle = "#aac";
        context.fillRect( 0, 0, 512, 512 );
        context.fillStyle = "#ccf";

        context.fillRect( 0, 0, 256, 256);
        context.fillRect( 256, 256, 256, 256);
        var textureCanvas = new THREE.Texture( imageCanvas, THREE.UVMapping, THREE.RepeatWrapping, THREE.RepeatWrapping),
            materialCanvas = new THREE.MeshBasicMaterial( { map: textureCanvas } );

        textureCanvas.needsUpdate = true;

        textureCanvas.repeat.set( 10000, 10000 );
        var geometry = new THREE.PlaneGeometry( 100, 100 );

        var floor = new THREE.Mesh( geometry, materialCanvas );

        floor.rotation.x = - Math.PI / 2;
        floor.scale.set( 10000, 10000, 10000 );
        floor.position.y = 200 ;
        scene.add(floor);





        // DRONE
        loader.load('ardrone2.obj');

        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        container.appendChild(renderer.domElement);

        window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        render();
    }


    var RAD_PER_DEG = Math.PI/180;
    function deg2Rad(deg) {
        return parseFloat(deg)*RAD_PER_DEG;
    }

    function render() {
        if(lastNavdata) {
            var x = lastNavdata.frontBackDegrees, y = lastNavdata.leftRightDegrees, z = lastNavdata.clockwiseDegrees,
                xr = deg2Rad(x), yr = deg2Rad(y), zr = deg2Rad(z);

                // height:
                //object.position.y = lastNavdata.altitude * 1000; // some scaling
            drone.rotation.set( xr, 0, -yr);
            floor.rotation.z = zr;
        }

        camera.lookAt(scene.position);

        renderer.render(scene, camera);
    }

    var keymap = {
        87 : { ev: 'move', param: 'front' }, // 'W'
        83 : { ev: 'move', param: 'back' }, // 'S'
        65 : { ev: 'move', param: 'left' }, // 'A'
        68 : { ev: 'move', param: 'right' }, // 'D'
        38 : { ev: 'move', param: 'up' }, // up
        40 : { ev: 'move', param: 'down' }, // down
        37 : { ev: 'move', param: 'counterClockwise' }, // left
        39 : { ev: 'move', param: 'clockwise' }, // right
        32 : { ev: 'drone', param: 'takeoff' }, // space
        27 : { ev: 'drone', param: 'land' },  // esc
        49 : { ev: 'animate', param: 'flipAhead', duration: 15 }, // 1
        50 : { ev: 'animate', param: 'flipLeft', duration: 15 }, // 2
        51 : { ev: 'animate', param: 'yawShake', duration: 15 }, // 3
        52 : { ev: 'animate', param: 'doublePhiThetaMixed', duration: 15 }, // 4
        53 : { ev: 'animate', param: 'wave', duration: 15 } // 5
    };

    var speed = 0;
    doc.addEventListener("keydown", function (ev) {
        if(!keymap[ev.keyCode]) {
            console.log('unmapped keycode', ev.keycode);
            return;
        }

        ev.preventDefault();

        speed = speed >= 1 ? 1 : speed + 0.08 / (1 - speed);
        console.log(speed);

        var evData = keymap[ev.keyCode];
        socket.emit(evData.ev, { action: evData.param, speed: speed, duration: evData.duration });
    }, false);

    doc.addEventListener("keyup", function (ev) {
        speed = 0;
        socket.emit('drone', { action: 'stop' });
    }, false);

</script>

</body>
</html>
